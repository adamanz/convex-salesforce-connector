<template>
    <lightning-card title="Convex CDC Connector Setup" icon-name="custom:custom63">
        <!-- Progress Indicator -->
        <lightning-progress-indicator current-step={currentStep} type="base" variant="base" class="slds-m-bottom_medium">
            <lightning-progress-step label="Welcome" value="1"></lightning-progress-step>
            <lightning-progress-step label="Connect" value="2"></lightning-progress-step>
            <lightning-progress-step label="Configure" value="3"></lightning-progress-step>
            <lightning-progress-step label="Enable CDC" value="4"></lightning-progress-step>
            <lightning-progress-step label="Complete" value="5"></lightning-progress-step>
        </lightning-progress-indicator>

        <div class="slds-p-around_medium">
            <!-- Step 1: Welcome -->
            <template if:true={isStep1}>
                <div class="slds-text-align_center slds-m-bottom_large">
                    <lightning-icon icon-name="utility:salesforce1" size="large" class="slds-m-bottom_medium"></lightning-icon>
                    <h1 class="slds-text-heading_large slds-m-bottom_small">Welcome to Convex CDC Connector</h1>
                    <p class="slds-text-body_regular slds-m-bottom_medium">
                        This wizard will connect your Salesforce org to Convex for real-time data sync using Change Data Capture.
                    </p>

                    <div class="slds-grid slds-gutters slds-wrap slds-m-bottom_medium">
                        <!-- What's New with OAuth -->
                        <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-2 slds-m-bottom_small">
                            <div class="slds-box slds-theme_success" style="height: 100%;">
                                <h2 class="slds-text-heading_small slds-m-bottom_small">
                                    <lightning-icon icon-name="utility:success" size="x-small" class="slds-m-right_x-small"></lightning-icon>
                                    One-Click Setup
                                </h2>
                                <ul class="slds-list_dotted slds-text-align_left">
                                    <li>Connect to Convex with OAuth</li>
                                    <li>Auto-configure webhook URLs</li>
                                    <li>Automatic secret synchronization</li>
                                    <li>No manual copy/paste required</li>
                                </ul>
                            </div>
                        </div>

                        <!-- Prerequisites -->
                        <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-2 slds-m-bottom_small">
                            <div class="slds-box slds-theme_shade" style="height: 100%;">
                                <h2 class="slds-text-heading_small slds-m-bottom_small">
                                    <lightning-icon icon-name="utility:check" size="x-small" class="slds-m-right_x-small"></lightning-icon>
                                    What you'll need:
                                </h2>
                                <ul class="slds-list_dotted slds-text-align_left">
                                    <li>A Convex account (free at <a href="https://convex.dev" target="_blank">convex.dev</a>)</li>
                                    <li>Admin access to this Salesforce org</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Time estimate -->
                    <div class="slds-box slds-theme_info slds-m-bottom_medium slds-text-align_center">
                        <lightning-icon icon-name="utility:clock" size="x-small" class="slds-m-right_x-small"></lightning-icon>
                        <strong>Setup time: ~2 minutes</strong>
                    </div>
                </div>
            </template>

            <!-- Step 2: Connect to Convex (OAuth) -->
            <template if:true={isStep2}>
                <h2 class="slds-text-heading_medium slds-m-bottom_medium">Connect to Convex</h2>

                <!-- Already Connected State -->
                <template if:true={isConnected}>
                    <div class="slds-box slds-theme_success slds-m-bottom_medium">
                        <div class="slds-grid slds-grid_vertical-align-center">
                            <div class="slds-col">
                                <lightning-icon icon-name="utility:success" variant="inverse" size="medium" class="slds-m-right_medium"></lightning-icon>
                            </div>
                            <div class="slds-col slds-grow">
                                <h3 class="slds-text-heading_small">Connected to Convex</h3>
                                <p class="slds-m-top_x-small">
                                    <strong>Team:</strong> {connectionTeam}<br/>
                                    <template if:true={connectionProject}>
                                        <strong>Project:</strong> {connectionProject}<br/>
                                    </template>
                                    <strong>Connected:</strong> {connectionDate}
                                </p>
                            </div>
                            <div class="slds-col">
                                <lightning-button label="Disconnect" variant="destructive-text" onclick={handleDisconnect}></lightning-button>
                            </div>
                        </div>
                    </div>
                </template>

                <!-- Not Connected State -->
                <template if:false={isConnected}>
                    <!-- OAuth Not Configured Warning -->
                    <template if:false={isOAuthConfigured}>
                        <div class="slds-box slds-theme_warning slds-m-bottom_large">
                            <div class="slds-grid slds-grid_vertical-align-start">
                                <lightning-icon icon-name="utility:warning" variant="warning" size="small" class="slds-m-right_small"></lightning-icon>
                                <div>
                                    <h3 class="slds-text-heading_small slds-m-bottom_small">OAuth Configuration Required</h3>
                                    <p class="slds-text-body_small slds-m-bottom_medium">Before connecting, you need to configure OAuth credentials. Follow these steps:</p>

                                    <div class="slds-box slds-theme_default slds-m-bottom_medium">
                                        <h4 class="slds-text-heading_small slds-m-bottom_small">Step 1: Register OAuth App with Convex</h4>
                                        <ol class="slds-list_ordered slds-text-body_small">
                                            <li class="slds-m-bottom_x-small">Go to <a href="https://dashboard.convex.dev" target="_blank" rel="noopener">Convex Dashboard</a></li>
                                            <li class="slds-m-bottom_x-small">Navigate to <strong>Settings → OAuth Applications</strong></li>
                                            <li class="slds-m-bottom_x-small">Register a new application with:
                                                <ul class="slds-list_dotted slds-m-left_medium slds-m-top_x-small">
                                                    <li><strong>Name:</strong> Salesforce CDC Connector</li>
                                                    <li><strong>Redirect URI:</strong> <code>{redirectUri}</code></li>
                                                </ul>
                                            </li>
                                            <li>Copy the <strong>Client ID</strong> and <strong>Client Secret</strong></li>
                                        </ol>
                                    </div>

                                    <div class="slds-box slds-theme_default slds-m-bottom_medium">
                                        <h4 class="slds-text-heading_small slds-m-bottom_small">Step 2: Configure Credentials in Salesforce</h4>
                                        <ol class="slds-list_ordered slds-text-body_small">
                                            <li class="slds-m-bottom_x-small">In Salesforce Setup, search for <strong>Custom Metadata Types</strong></li>
                                            <li class="slds-m-bottom_x-small">Click <strong>Manage Records</strong> next to <strong>Convex OAuth Settings</strong></li>
                                            <li class="slds-m-bottom_x-small">Click <strong>New</strong> and enter:
                                                <ul class="slds-list_dotted slds-m-left_medium slds-m-top_x-small">
                                                    <li><strong>Label:</strong> Default</li>
                                                    <li><strong>Client Id:</strong> (from Step 1)</li>
                                                    <li><strong>Client Secret:</strong> (from Step 1)</li>
                                                    <li><strong>Redirect URI:</strong> <code>{redirectUri}</code></li>
                                                </ul>
                                            </li>
                                            <li>Click <strong>Save</strong></li>
                                        </ol>
                                    </div>

                                    <div class="slds-grid slds-grid_align-center slds-gutters">
                                        <div class="slds-col">
                                            <lightning-button
                                                label="Open Custom Metadata Setup"
                                                variant="neutral"
                                                onclick={openCustomMetadataSetup}
                                                icon-name="utility:settings">
                                            </lightning-button>
                                        </div>
                                        <div class="slds-col">
                                            <lightning-button
                                                label="Refresh"
                                                variant="brand"
                                                onclick={checkOAuthConfiguration}
                                                icon-name="utility:refresh">
                                            </lightning-button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>

                    <!-- OAuth Configured - Show Connect Button -->
                    <template if:true={isOAuthConfigured}>
                        <div class="slds-text-align_center slds-m-bottom_large">
                            <div class="slds-box slds-box_small slds-theme_shade slds-m-bottom_medium" style="max-width: 400px; margin: 0 auto;">
                                <lightning-icon icon-name="standard:connected_apps" size="large" class="slds-m-bottom_medium"></lightning-icon>
                                <h3 class="slds-text-heading_small slds-m-bottom_small">Connect with Convex</h3>
                                <p class="slds-text-body_small slds-m-bottom_medium">
                                    Click the button below to securely connect this Salesforce org to your Convex project.
                                </p>
                                <lightning-button
                                    label="Connect to Convex"
                                    variant="brand"
                                    onclick={initiateOAuth}
                                    disabled={isLoading}
                                    icon-name="utility:link"
                                    class="slds-m-bottom_small">
                                </lightning-button>
                                <template if:true={isLoading}>
                                    <lightning-spinner alternative-text="Loading..." size="small" class="slds-m-left_small"></lightning-spinner>
                                </template>
                            </div>

                            <div class="slds-box slds-theme_default slds-m-top_medium" style="max-width: 500px; margin: 0 auto;">
                                <h4 class="slds-text-heading_small slds-m-bottom_x-small">What happens next:</h4>
                                <ol class="slds-list_ordered slds-text-align_left slds-text-body_small">
                                    <li class="slds-m-bottom_x-small">You'll be redirected to Convex to sign in</li>
                                    <li class="slds-m-bottom_x-small">Select your team and project (or create a new one)</li>
                                    <li class="slds-m-bottom_x-small">Authorize the connector to access your project</li>
                                    <li>You'll be redirected back here automatically</li>
                                </ol>
                            </div>
                        </div>
                    </template>

                    <!-- New to Convex? -->
                    <div class="slds-box slds-theme_info slds-m-top_medium">
                        <h4 class="slds-text-heading_small slds-m-bottom_x-small">
                            <lightning-icon icon-name="utility:new" size="x-small" class="slds-m-right_x-small"></lightning-icon>
                            New to Convex?
                        </h4>
                        <p class="slds-text-body_small">
                            Sign up for free at <a href="https://dashboard.convex.dev" target="_blank" rel="noopener"><strong>dashboard.convex.dev</strong></a>.
                            You can create a new project during the connection process.
                        </p>
                    </div>
                </template>
            </template>

            <!-- Step 3: Configure (Auto-configuration) -->
            <template if:true={isStep3}>
                <h2 class="slds-text-heading_medium slds-m-bottom_medium">Configure Connection</h2>

                <template if:false={configurationComplete}>
                    <div class="slds-text-align_center slds-m-bottom_large">
                        <p class="slds-m-bottom_medium">Click below to automatically configure the webhook connection.</p>

                        <lightning-button
                            label="Auto-Configure"
                            variant="brand"
                            onclick={autoConfigureWebhook}
                            disabled={isLoading}
                            icon-name="utility:settings">
                        </lightning-button>

                        <template if:true={isLoading}>
                            <div class="slds-m-top_medium">
                                <lightning-spinner alternative-text="Configuring..." size="medium"></lightning-spinner>
                                <p class="slds-m-top_small slds-text-body_small">{configurationStatus}</p>
                            </div>
                        </template>
                    </div>
                </template>

                <template if:true={configurationComplete}>
                    <div class="slds-box slds-theme_success slds-m-bottom_medium">
                        <lightning-icon icon-name="utility:success" variant="inverse" size="small" class="slds-m-right_small"></lightning-icon>
                        <strong>Configuration Complete!</strong>
                    </div>

                    <div class="slds-box slds-theme_shade slds-m-bottom_medium">
                        <h3 class="slds-text-heading_small slds-m-bottom_small">Connection Details</h3>
                        <dl class="slds-dl_horizontal">
                            <dt class="slds-dl_horizontal__label">Webhook URL:</dt>
                            <dd class="slds-dl_horizontal__detail">
                                <code>{webhookUrl}</code>
                            </dd>
                            <dt class="slds-dl_horizontal__label">Secret Configured:</dt>
                            <dd class="slds-dl_horizontal__detail">
                                <lightning-icon icon-name="utility:success" size="xx-small" class="slds-m-right_xx-small"></lightning-icon>
                                Yes (auto-synced)
                            </dd>
                            <dt class="slds-dl_horizontal__label">Connection Test:</dt>
                            <dd class="slds-dl_horizontal__detail">
                                <template if:true={testSuccess}>
                                    <lightning-icon icon-name="utility:success" size="xx-small" variant="success" class="slds-m-right_xx-small"></lightning-icon>
                                    Passed
                                </template>
                                <template if:false={testSuccess}>
                                    <lightning-button label="Test Connection" variant="neutral" onclick={testConnection} size="small"></lightning-button>
                                </template>
                            </dd>
                        </dl>
                    </div>
                </template>

                <!-- Manual Override Option -->
                <div class="slds-m-top_large">
                    <lightning-accordion allow-multiple-sections-open>
                        <lightning-accordion-section name="manual" label="Manual Configuration (Advanced)">
                            <lightning-input
                                type="url"
                                label="Webhook URL"
                                placeholder="https://your-project.convex.site/webhooks/salesforce/cdc"
                                value={webhookUrl}
                                onchange={handleWebhookUrlChange}
                                field-level-help="Override the auto-detected webhook URL"
                                class="slds-m-bottom_medium">
                            </lightning-input>

                            <div class="slds-grid slds-gutters slds-m-bottom_medium">
                                <div class="slds-col slds-size_3-of-4">
                                    <lightning-input
                                        type="text"
                                        label="Webhook Secret"
                                        value={webhookSecret}
                                        onchange={handleWebhookSecretChange}
                                        placeholder="Enter or generate a secret key"
                                        field-level-help="Override the auto-generated secret">
                                    </lightning-input>
                                </div>
                                <div class="slds-col slds-size_1-of-4 slds-grid slds-grid_vertical-align-end">
                                    <lightning-button
                                        label="Generate"
                                        onclick={generateSecret}
                                        variant="neutral">
                                    </lightning-button>
                                </div>
                            </div>

                            <lightning-button label="Save Manual Config" variant="neutral" onclick={saveManualConfig}></lightning-button>
                        </lightning-accordion-section>
                    </lightning-accordion>
                </div>
            </template>

            <!-- Step 4: Enable CDC -->
            <template if:true={isStep4}>
                <h2 class="slds-text-heading_medium slds-m-bottom_medium">Enable Change Data Capture</h2>

                <div class="slds-box slds-theme_shade slds-m-bottom_medium">
                    <h3 class="slds-text-heading_small slds-m-bottom_small">Follow these steps in Salesforce Setup:</h3>
                    <ol class="slds-list_ordered">
                        <li class="slds-m-bottom_small">
                            Go to <strong>Setup</strong> → Search for <strong>"Change Data Capture"</strong>
                        </li>
                        <li class="slds-m-bottom_small">
                            Select the objects you want to sync:
                            <ul class="slds-list_dotted slds-m-top_x-small slds-m-left_medium">
                                <li>Account</li>
                                <li>Contact</li>
                                <li>Lead</li>
                                <li>Opportunity</li>
                                <li>Any custom objects you need</li>
                            </ul>
                        </li>
                        <li class="slds-m-bottom_small">
                            Click <strong>Save</strong>
                        </li>
                    </ol>
                </div>

                <lightning-button
                    label="Open Change Data Capture Setup"
                    variant="brand"
                    onclick={openCDCSetup}
                    icon-name="utility:new_window"
                    class="slds-m-bottom_medium">
                </lightning-button>

                <div class="slds-box slds-theme_info slds-m-top_medium">
                    <p><lightning-icon icon-name="utility:info" size="x-small" class="slds-m-right_x-small"></lightning-icon>
                    CDC triggers are already deployed with this package. They will start sending events once CDC is enabled for each object.</p>
                </div>
            </template>

            <!-- Step 5: Complete -->
            <template if:true={isStep5}>
                <div class="slds-text-align_center">
                    <lightning-icon icon-name="utility:success" variant="success" size="large" class="slds-m-bottom_medium"></lightning-icon>
                    <h2 class="slds-text-heading_large slds-m-bottom_small slds-text-color_success">Setup Complete!</h2>
                    <p class="slds-text-body_regular slds-m-bottom_large">
                        Your Convex CDC Connector is now configured. Changes to your Salesforce data will automatically sync to Convex.
                    </p>

                    <div class="slds-box slds-theme_shade slds-m-bottom_large" style="max-width: 500px; margin: 0 auto;">
                        <h3 class="slds-text-heading_small slds-m-bottom_small">Connection Summary</h3>
                        <dl class="slds-dl_horizontal slds-text-align_left">
                            <dt class="slds-dl_horizontal__label">Team:</dt>
                            <dd class="slds-dl_horizontal__detail">{connectionTeam}</dd>
                            <template if:true={connectionProject}>
                                <dt class="slds-dl_horizontal__label">Project:</dt>
                                <dd class="slds-dl_horizontal__detail">{connectionProject}</dd>
                            </template>
                            <dt class="slds-dl_horizontal__label">Webhook:</dt>
                            <dd class="slds-dl_horizontal__detail"><code class="slds-text-body_small">{webhookUrl}</code></dd>
                        </dl>
                    </div>

                    <div class="slds-box slds-theme_default slds-m-bottom_large" style="max-width: 500px; margin: 0 auto;">
                        <h3 class="slds-text-heading_small slds-m-bottom_small">Next Steps</h3>
                        <ul class="slds-list_dotted slds-text-align_left">
                            <li>Make a test change in Salesforce (e.g., update an Account)</li>
                            <li>Check your Convex dashboard to verify the sync</li>
                            <li>View sync status in Convex logs</li>
                        </ul>
                    </div>

                    <div class="slds-grid slds-grid_align-center slds-gutters">
                        <div class="slds-col">
                            <lightning-button
                                label="View Documentation"
                                variant="neutral"
                                onclick={openDocs}
                                icon-name="utility:open">
                            </lightning-button>
                        </div>
                        <div class="slds-col">
                            <lightning-button
                                label="Open Convex Dashboard"
                                variant="brand"
                                onclick={openConvexDashboard}
                                icon-name="utility:new_window">
                            </lightning-button>
                        </div>
                    </div>
                </div>
            </template>
        </div>

        <!-- Navigation Footer -->
        <div slot="footer" class="slds-grid slds-grid_align-spread">
            <lightning-button
                label="Previous"
                onclick={previousStep}
                disabled={isFirstStep}
                variant="neutral">
            </lightning-button>
            <lightning-button
                label={nextButtonLabel}
                onclick={nextStep}
                disabled={isNextDisabled}
                variant="brand">
            </lightning-button>
        </div>
    </lightning-card>
</template>
